From a93e0ee6ffce31e4fd40169dc9663f735513dbed Mon Sep 17 00:00:00 2001
From: belijzajac <tautvydas749@gmail.com>
Date: Thu, 23 Mar 2023 22:13:49 +0200
Subject: [PATCH] Update linking

---
 bindings/node.js/Makefile         |  2 --
 bindings/node.js/binding.dist.gyp | 27 +--------------------------
 bindings/node.js/binding.gyp      |  3 +--
 3 files changed, 2 insertions(+), 30 deletions(-)

diff --git a/bindings/node.js/Makefile b/bindings/node.js/Makefile
index 0071df0..5398add 100644
--- a/bindings/node.js/Makefile
+++ b/bindings/node.js/Makefile
@@ -9,7 +9,6 @@ clean:
 	rm -rf node_modules
 
 build: src/kzg.cxx lib/kzg.ts package.json binding.gyp Makefile
-	cd ../../src && make c_kzg_4844.o && cp c_kzg_4844.o ../bindings/node.js
 	yarn install
 	yarn node-gyp rebuild
 
@@ -28,7 +27,6 @@ bundle: clean
 	cp -r src dist/src
 	mkdir -p dist/deps/c-kzg
 	cp -r ../../blst dist/deps
-	cp ../../src/c_kzg_4844.c dist/deps/c-kzg
 	cp ../../src/c_kzg_4844.h dist/deps/c-kzg
 
 publish: bundle
diff --git a/bindings/node.js/binding.dist.gyp b/bindings/node.js/binding.dist.gyp
index c9f1108..0837496 100644
--- a/bindings/node.js/binding.dist.gyp
+++ b/bindings/node.js/binding.dist.gyp
@@ -19,34 +19,9 @@
         "<!@(node -p \"require('node-addon-api').include\")"
       ],
       "libraries": [
-        "<(module_root_dir)/c_kzg_4844.o",
-        "<(module_root_dir)/libblst.a"
+        "<(module_root_dir)/../../../../target/release/libblst_from_scratch.a"
       ],
       "dependencies": ["<!(node -p \"require('node-addon-api').gyp\")"],
-      "actions": [
-        {
-          "action_name": "build_blst",
-          "inputs": ["<(module_root_dir)/deps/blst/build.sh"],
-          "outputs": ["<(module_root_dir)/libblst.a"],
-          "action": ["<(module_root_dir)/deps/blst/build.sh"]
-        },
-        {
-          "action_name": "build_ckzg",
-          "inputs": [
-            "<(module_root_dir)/deps/c-kzg/c_kzg_4844.c",
-            "<(module_root_dir)/libblst.a"
-          ],
-          "outputs": ["<(module_root_dir)/c_kzg_4844.o"],
-          "action": [
-            "cc",
-            "-I<(module_root_dir)/deps/blst/bindings",
-            "-DFIELD_ELEMENTS_PER_BLOB=<!(echo ${FIELD_ELEMENTS_PER_BLOB:-4096})",
-            "-O2",
-            "-c",
-            "<(module_root_dir)/deps/c-kzg/c_kzg_4844.c"
-          ]
-        }
-      ]
     }
   ]
 }
diff --git a/bindings/node.js/binding.gyp b/bindings/node.js/binding.gyp
index 8b6ce32..073c687 100644
--- a/bindings/node.js/binding.gyp
+++ b/bindings/node.js/binding.gyp
@@ -19,8 +19,7 @@
         "<!@(node -p \"require('node-addon-api').include\")"
       ],
       "libraries": [
-        "<(module_root_dir)/c_kzg_4844.o",
-        "<(module_root_dir)/../../lib/libblst.a"
+        "<(module_root_dir)/../../../../target/release/libblst_from_scratch.a"
       ],
       "dependencies": ["<!(node -p \"require('node-addon-api').gyp\")"]
     }
-- 
2.40.0

